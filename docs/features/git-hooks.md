# Git Hook Integration

**Status:** Proposed

## Overview

Auto-jot diary entries when git events occur. Capture commit messages, branch changes, and work context automatically.

## Use Cases

- **Commit journaling** — Log every commit with message and context
- **Branch context** — Note when switching to new feature branches
- **Merge tracking** — Record merge events and conflicts
- **Work session logging** — Track time spent on different branches

## Proposed Interface

### Installation

```bash
# Install git hooks in current repo
diaryctl git-hooks install

# Install globally
diaryctl git-hooks install --global

# Uninstall
diaryctl git-hooks uninstall
```

### Configuration

```toml
# ~/.diaryctl/config.toml
[git_hooks]
enabled = true

[git_hooks.post_commit]
enabled = true
template = "commit-log"
format = "**{{.Branch}}**: {{.Message}} ({{.FilesChanged}} files)"

[git_hooks.post_checkout]
enabled = true
on_branch_change = true  # Only on branch switch, not file checkout
template = "context-switch"
format = "Switched to **{{.Branch}}**"

[git_hooks.post_merge]
enabled = true
template = "merge-log"
format = "Merged **{{.Source}}** into **{{.Target}}**"
```

### Hook Scripts

**post-commit:**
```bash
#!/bin/bash
# .git/hooks/post-commit

BRANCH=$(git rev-parse --abbrev-ref HEAD)
MESSAGE=$(git log -1 --pretty=%B)
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only HEAD -r | wc -l)

diaryctl jot "**${BRANCH}**: ${MESSAGE} (${FILES_CHANGED} files)" --template commit-log
```

**post-checkout:**
```bash
#!/bin/bash
# .git/hooks/post-checkout

PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_SWITCH=$3  # 1 if branch change, 0 if file checkout

if [ "$BRANCH_SWITCH" = "1" ]; then
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    diaryctl jot "Switched to **${BRANCH}**" --template context-switch
fi
```

## Hook Types

| Hook | Event | Default |
|------|-------|---------|
| `post-commit` | After commit | Enabled |
| `post-checkout` | After checkout/branch switch | Enabled |
| `post-merge` | After merge | Disabled |
| `post-rewrite` | After rebase/amend | Disabled |

## Auto-Jot Format

### Commit Entry

```markdown
- **09:15** **feature/auth**: Implement JWT token validation (3 files)
```

### Branch Switch Entry

```markdown
- **10:30** Switched to **feature/user-profiles**
```

### Merge Entry

```markdown
- **14:45** Merged **feature/auth** into **main**
```

## Implementation

### Hook Template

```go
const postCommitHook = `#!/bin/bash
# Auto-generated by diaryctl git-hooks install
# DO NOT MODIFY MANUALLY

CONFIG_FILE="$HOME/.diaryctl/config.toml"

# Check if enabled
if ! grep -q "enabled = true" "$CONFIG_FILE" 2>/dev/null; then
    exit 0
fi

# Gather context
BRANCH=$(git rev-parse --abbrev-ref HEAD)
MESSAGE=$(git log -1 --pretty=%B | head -1)
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only HEAD -r | wc -l | tr -d ' ')

# Jot to diary
{{.DiaryctlPath}} jot "**${BRANCH}**: ${MESSAGE} (${FILES_CHANGED} files)" 2>/dev/null
`
```

### Install Command

```go
func InstallHooks(opts InstallOptions) error {
    gitDir := findGitDir(opts.Global)

    hooks := []string{"post-commit", "post-checkout", "post-merge"}

    for _, hook := range hooks {
        if !isEnabled(hook) {
            continue
        }

        hookPath := filepath.Join(gitDir, "hooks", hook)

        // Check if hook already exists
        if exists(hookPath) {
            if !opts.Force {
                return fmt.Errorf("hook %s already exists (use --force)", hook)
            }
        }

        // Generate and write hook
        content := generateHook(hook)
        if err := os.WriteFile(hookPath, []byte(content), 0755); err != nil {
            return err
        }
    }

    return nil
}
```

### Global Hooks

Git 2.9+ supports global hooks:

```bash
git config --global core.hooksPath ~/.config/git/hooks
```

The install command can set this up:

```go
func InstallGlobalHooks() error {
    hooksDir := filepath.Join(os.Getenv("HOME"), ".config", "git", "hooks")
    os.MkdirAll(hooksDir, 0755)

    // Set global hooks path
    exec.Command("git", "config", "--global", "core.hooksPath", hooksDir).Run()

    // Install hooks
    return installToDir(hooksDir)
}
```

## TUI Integration

When viewing a day's entries in TUI:

```
┌─ Today ────────────────────────┐
│                                │
│  [Daily Entry]                 │
│  ...                           │
│                                │
│  ── Git Activity ──            │
│  • 09:15 feature/auth: Impl... │
│  • 10:30 Switched to feature/..│
│                                │
│  g: toggle git activity        │
└────────────────────────────────┘
```

Option to hide auto-generated entries or show them in a separate section.

## Configuration Options

```toml
[git_hooks]
enabled = true

# Filter which commits get logged
[git_hooks.filters]
min_files_changed = 1      # Skip empty commits
exclude_branches = ["main", "master"]  # Don't log on main
exclude_messages = ["wip", "fixup"]   # Skip WIP commits

# Formatting
[git_hooks.format]
commit = "**{{.Branch}}**: {{.Message}}"
branch_switch = "Switched to **{{.Branch}}**"
merge = "Merged **{{.Source}}** into **{{.Target}}**"
```

## Design Decisions

### Opt-In

Git hooks are not installed by default. Users must explicitly run `diaryctl git-hooks install`.

### Per-Repo or Global

Support both local (per-repo) and global installation. Local takes precedence for team-specific workflows.

### Template-Based

Use templates for auto-generated entries so users can customize format and structure.

### Silent Failures

Git hooks should not fail the git operation. All errors are logged to `~/.diaryctl/git-hooks.log`.

## Security Considerations

- Hooks execute with user's permissions
- No network calls from hooks
- No shell injection (sanitize git output)

## Future Enhancements

- **Smart grouping** — Batch multiple commits into single jot
- **Time tracking** — Calculate time between commits on same branch
- **PR linking** — Detect PR numbers in commit messages
- **Issue tracking** — Parse issue references from commits

## Related Features

- [Context Providers](../plans/2026-02-02-context-providers-design.md) — Git context is already captured
- [Recurring Entries](recurring-entries.md) — Could trigger on commit patterns

---

*This is a proposed feature. No design document exists yet.*
