# Shell Integration

**Status:** Implemented  
**Design Doc:** `docs/plans/2026-02-02-shell-integration-design.md`

## Overview

Shell integration exposes diary status (today indicator, streak, current template) in the terminal prompt. Supports bash and zsh with Starship compatibility.

## Quick Start

Add to your shell configuration:

```bash
# ~/.bashrc or ~/.zshrc
eval "$(diaryctl init bash)"  # or 'zsh'
```

## Commands

### `diaryctl init <shell>`

Outputs shell initialization script:

```bash
# Generates completions and prompt hooks
diaryctl init bash
```

Output includes:
- Cobra-generated shell completions
- `__diaryctl_prompt_hook` function
- `diaryctl_prompt_info` helper function
- Prompt command registration

### `diaryctl status`

Standalone status command:

```bash
$ diaryctl status
âœ“ 7ðŸ”¥ morning

$ diaryctl status --format "{{.TodayIcon}} {{.Streak}}{{.StreakIcon}} {{.Template}}"
âœ“ 7ðŸ”¥ morning

$ diaryctl status --env
export DIARYCTL_TODAY="âœ“"
export DIARYCTL_STREAK="7"
export DIARYCTL_STREAK_ICON="ðŸ”¥"
export DIARYCTL_TEMPLATE="morning"
```

## Environment Variables

Set by the prompt hook:

| Variable | Example | Description |
|----------|---------|-------------|
| `DIARYCTL_TODAY` | `âœ“` or `âœ—` | Today entry indicator |
| `DIARYCTL_STREAK` | `7` | Consecutive days count |
| `DIARYCTL_STREAK_ICON` | `ðŸ”¥` | Streak suffix icon |
| `DIARYCTL_TEMPLATE` | `morning` | Current default template |
| `DIARYCTL_BACKEND` | `markdown` | Storage backend |

## Configuration

Add to `~/.diaryctl/config.toml`:

```toml
[shell]
cache_ttl = "5m"         # Duration string, default 5m
today_icon = "âœ“"         # Shown when today entry exists
no_today_icon = "âœ—"      # Shown when no today entry
streak_icon = "ðŸ”¥"       # Shown after streak count
show_context = true      # Show template name in prompt
show_backend = false     # Show storage backend
```

## Starship Integration

### Option A: Custom Command (standalone)

```toml
# ~/.config/starship.toml
[custom.diaryctl]
command = "diaryctl status"
when = "command -v diaryctl"
shell = ["bash", "--nologin"]
format = "[$output]($style) "
style = "bold yellow"
```

### Option B: Environment Variables (faster)

```toml
# ~/.config/starship.toml
[env_var.DIARYCTL_TODAY]
format = "[$env_value](bold green)"

[env_var.DIARYCTL_STREAK]
format = "[$env_value](bold yellow)"

[env_var.DIARYCTL_STREAK_ICON]
format = "[$env_value](bold yellow)"
```

## Cache Design

Cache location: `~/.diaryctl/.prompt-cache` (JSON)

```json
{
  "today": true,
  "streak": 7,
  "today_date": "2026-02-02",
  "default_template": "morning",
  "storage_backend": "markdown",
  "updated_at": "2026-02-02T14:30:00Z"
}
```

### Cache Invalidation

- Mutating commands (`create`, `jot`, `edit`, `update`, `delete`) invalidate cache
- Date change (midnight rollover) triggers refresh
- Manual refresh: `diaryctl status --refresh`

## Bash Init Script

```bash
# Generated by `diaryctl init bash`
__diaryctl_prompt_hook() {
  eval "$(command diaryctl status --env 2>/dev/null)"
}

diaryctl_prompt_info() {
  command diaryctl status 2>/dev/null
}

if [[ -z "$PROMPT_COMMAND" ]]; then
  PROMPT_COMMAND="__diaryctl_prompt_hook"
else
  PROMPT_COMMAND="__diaryctl_prompt_hook;${PROMPT_COMMAND}"
fi

eval "$(command diaryctl completion bash 2>/dev/null)"
```

## Zsh Init Script

```zsh
# Generated by `diaryctl init zsh`
__diaryctl_prompt_hook() {
  eval "$(command diaryctl status --env 2>/dev/null)"
}

diaryctl_prompt_info() {
  command diaryctl status 2>/dev/null
}

autoload -Uz add-zsh-hook
add-zsh-hook precmd __diaryctl_prompt_hook

eval "$(command diaryctl completion zsh 2>/dev/null)"
```

## Files

- `cmd/init_shell.go` â€” `diaryctl init` command
- `cmd/status.go` â€” `diaryctl status` command
- `internal/shell/cache.go` â€” Prompt cache read/write
- `internal/shell/streak.go` â€” Streak computation

## Related Features

- [Fish Shell Support](fish-shell.md) â€” Proposed extension
- [Starship Preset](starship-preset.md) â€” Official preset configuration

---

*See design doc for complete specification.*
