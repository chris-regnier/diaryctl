name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.24']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: task test

      - name: Build
        run: task build

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run lint
        run: task lint

  gavel:
    name: Gavel Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD -- '*.go' > /tmp/pr.diff
          echo "--- Diff stats ---"
          wc -l /tmp/pr.diff
          if [ ! -s /tmp/pr.diff ]; then
            echo "No Go file changes, skipping analysis"
            echo "SKIP_ANALYSIS=true" >> "$GITHUB_ENV"
          fi

      - name: Download Gavel
        if: env.SKIP_ANALYSIS != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download v0.4.0 \
            --repo chris-regnier/gavel \
            --pattern "gavel_v0.4.0_Linux_x86_64.tar.gz" \
            --dir /tmp || true
          if [ ! -f "/tmp/gavel_v0.4.0_Linux_x86_64.tar.gz" ]; then
            echo "::warning::Could not download Gavel binary. Skipping analysis."
            echo "SKIP_ANALYSIS=true" >> "$GITHUB_ENV"
            exit 0
          fi
          tar -xzf /tmp/gavel_v0.4.0_Linux_x86_64.tar.gz -C /tmp
          chmod +x /tmp/gavel_Linux_x86_64
          /tmp/gavel_Linux_x86_64 version

      - name: Run Gavel analysis
        if: env.SKIP_ANALYSIS != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          /tmp/gavel_Linux_x86_64 analyze \
            --diff /tmp/pr.diff \
            --output /tmp/gavel-results

      - name: Evaluate verdict
        if: env.SKIP_ANALYSIS != 'true'
        run: |
          # Find the latest result directory (Gavel creates timestamped subdirs)
          RESULT_DIR=$(ls -td /tmp/gavel-results/*/ 2>/dev/null | head -1)
          if [ -z "$RESULT_DIR" ]; then
            echo "::error::No Gavel results found"
            exit 1
          fi

          VERDICT_FILE="${RESULT_DIR}verdict.json"
          if [ ! -f "$VERDICT_FILE" ]; then
            echo "::error::No verdict.json found in ${RESULT_DIR}"
            exit 1
          fi

          DECISION=$(jq -r '.decision' "$VERDICT_FILE")
          REASON=$(jq -r '.reason // "No reason provided"' "$VERDICT_FILE")

          echo "## Gavel Verdict" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Decision:** \`${DECISION}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Reason:** ${REASON}" >> "$GITHUB_STEP_SUMMARY"

          if [ "$DECISION" = "reject" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Relevant Findings" >> "$GITHUB_STEP_SUMMARY"
            jq -r '.relevant_findings[]? | "- **\(.ruleId // "unknown")** (\(.level // "note")): \(.message.text // "No message")"' \
              "$VERDICT_FILE" >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || true
            echo "::error::Gavel rejected this PR: ${REASON}"
            exit 1
          fi

          echo "Gavel decision: ${DECISION}"

      - name: Prepare SARIF for upload
        if: always() && env.SKIP_ANALYSIS != 'true'
        run: |
          # Find the SARIF file in the nested result directory
          RESULT_DIR=$(ls -td /tmp/gavel-results/*/ 2>/dev/null | head -1)
          if [ -n "$RESULT_DIR" ] && [ -f "${RESULT_DIR}sarif.json" ]; then
            # Copy to a known location with .sarif extension for upload action
            mkdir -p /tmp/sarif-upload
            cp "${RESULT_DIR}sarif.json" /tmp/sarif-upload/results.sarif
            echo "SARIF_FILE=/tmp/sarif-upload/results.sarif" >> "$GITHUB_ENV"
          else
            echo "::warning::No SARIF file found to upload"
          fi

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        if: always() && env.SKIP_ANALYSIS != 'true' && env.SARIF_FILE != ''
        with:
          sarif_file: ${{ env.SARIF_FILE }}
          category: gavel
